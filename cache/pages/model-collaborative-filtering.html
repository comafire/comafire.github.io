
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Collaborative-Filtering">Collaborative Filtering<a class="anchor-link" href="#Collaborative-Filtering">&#182;</a></h1><p>협업필터링은 비슷한 성향을 가진 사용자는 비슷한 아이템을 선호 할 것이라는 가정에서 출발한 알고리즘입니다. 사용자가 아이템에 대해서 투표한 평점 로그 데이터를 이용하며, 사용자나 아이템을 기준으로 평점의 유사성을 살피는 Memory-based CF와 평점 데이터를 통해 모델을 만들고 평점을 예측하는 Model-based CF이 있습니다.</p>
<h2 id="Memory-based-CF(Collaborative-Filtering)">Memory-based CF(Collaborative Filtering)<a class="anchor-link" href="#Memory-based-CF(Collaborative-Filtering)">&#182;</a></h2><p>평점 행렬을 기억하고 평점 예측을 위해 기억된 행렬 기반으로 유사도 계산을 진행하기 때문에 Memory-based CF라고 불립니다. 이 방법들은 평점 데이터가 충분히 있을 경우 간단하면서 좋은 성능을 나타내지만, 평점 데이터가 없는 새로운 유저 및 아이템 추가시 대응이 어렵다는 단점이 있습니다.</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*NTd4NH0H1mrSr01Ppr58dg.png" alt="matrix"></p>
<p><strong>User-based CF</strong></p>
<ul>
<li>평점 행렬에서 사용자 평점 벡터 기준으로 유사한 사용자를 찾아서 이를 기반으로 원하는 아이템의 평점을 계산하는 방법</li>
<li>예) E 사용자의 TV 아이템 평점을 예측하고자 할때, E 사용자와 비슷한 아이템 평점 벡터를 가진 B, C 사용자의 TV 아이템 평점벡터를 기준으로 예측</li>
</ul>
<p><strong>Item-based CF</strong></p>
<ul>
<li>평점 행렬에서 아이템 평점 벡터 기준으로 유사한 아이템를 찾아서 이를 기반으로 원하는 사용지의 평점을 계산하는 방법</li>
<li>예) TV 아이템의 E 사용자 평점을 예측하고자 할대, TV 아이템과 비슷한 사용자 평점 벡터를 가진 게임패트 아이템의 사용자 평점벡터를 기준으로 예측</li>
</ul>
<p>유사도 계산을 위해 surprise 패키지는 다음과 같은 유사도 기준을 제공합니다.</p>
<ul>
<li>평균제곱차이 유사도 ('msd': Mean Squared Difference Similarity)</li>
<li>코사인 유사도 ('cosine': Cosine Similarity)</li>
<li>피어슨 유사도 ('psearson': Pearson Similarity)</li>
<li>피어슨-베이스라인 유사도 ('pearson_baseline': Pearson-Baseline Similarity)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">preprocessing</span><span class="p">,</span> <span class="n">model_selection</span><span class="p">,</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">surprise</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># 데이터</span>
<span class="n">sp_data</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-100k&#39;</span><span class="p">)</span>
<span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sp_data</span><span class="o">.</span><span class="n">raw_ratings</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_data.shape=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>

<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># 전처리 </span>
<span class="c1"># A reader is still needed but only the rating_scale param is requiered.</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">rating_scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sp_data</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">reader</span><span class="p">)</span>
<span class="c1"># surprise model.test 의 input shape =&gt; [(user_id, item_id, rating)]</span>
<span class="n">sp_test</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_test</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

<span class="c1"># 모델</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;msd&#39;</span><span class="p">}),</span> 
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;cosine&#39;</span><span class="p">}),</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;pearson&#39;</span><span class="p">}),</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;msd&#39;</span><span class="p">,</span> <span class="s1">&#39;user_based&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="s1">&#39;user_based&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">KNNBasic</span><span class="p">(</span><span class="n">sim_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;user_based&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>    
<span class="p">]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="c1"># 학습</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sp_data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># 평가</span>
    <span class="n">sp_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">sp_test</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">accuracy</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">sp_pred</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test RMSE=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>df_data.shape=(100000, 4)
user_id       object
item_id       object
rating       float64
timestamp     object
dtype: object
  user_id item_id  rating  timestamp
0     196     242     3.0  881250949
1     186     302     3.0  891717742
2      22     377     1.0  878887116
3     244      51     2.0  880606923
4     166     346     1.0  886397596
       user_id item_id         rating  timestamp
count   100000  100000  100000.000000     100000
unique     943    1682            NaN      49282
top        405      50            NaN  891033606
freq       737     583            NaN         12
mean       NaN     NaN       3.529860        NaN
std        NaN     NaN       1.125674        NaN
min        NaN     NaN       1.000000        NaN
25%        NaN     NaN       3.000000        NaN
50%        NaN     NaN       4.000000        NaN
75%        NaN     NaN       4.000000        NaN
max        NaN     NaN       5.000000        NaN
(100000, 4) (90000, 4) (10000, 4)
Computing the msd similarity matrix...
Done computing similarity matrix.
Computing the msd similarity matrix...
Done computing similarity matrix.
Computing the msd similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.7832  0.7878  0.7859  0.7856  0.0019  
RMSE (testset)    0.9920  0.9944  0.9936  0.9933  0.0010  
Fit time          0.17    0.19    0.19    0.19    0.01    
Test time         5.68    5.72    5.97    5.79    0.13    
Test RMSE=0.9919432379164125
Computing the cosine similarity matrix...
Done computing similarity matrix.
Computing the cosine similarity matrix...
Done computing similarity matrix.
Computing the cosine similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.8117  0.8131  0.8078  0.8108  0.0023  
RMSE (testset)    1.0238  1.0268  1.0199  1.0235  0.0028  
Fit time          0.88    0.89    0.94    0.90    0.02    
Test time         6.06    5.92    6.05    6.01    0.06    
Test RMSE=1.0224081647696446
Computing the pearson similarity matrix...
Done computing similarity matrix.
Computing the pearson similarity matrix...
Done computing similarity matrix.
Computing the pearson similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.8114  0.8102  0.8172  0.8129  0.0031  
RMSE (testset)    1.0219  1.0219  1.0286  1.0241  0.0032  
Fit time          1.46    1.45    1.37    1.43    0.04    
Test time         5.73    6.43    6.56    6.24    0.36    
Test RMSE=1.0245770389211275
Computing the msd similarity matrix...
Done computing similarity matrix.
Computing the msd similarity matrix...
Done computing similarity matrix.
Computing the msd similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.7847  0.7917  0.7826  0.7863  0.0039  
RMSE (testset)    0.9887  0.9978  0.9883  0.9916  0.0044  
Fit time          0.29    0.30    0.28    0.29    0.01    
Test time         7.29    6.82    6.83    6.98    0.22    
Test RMSE=0.9876095694171025
Computing the cosine similarity matrix...
Done computing similarity matrix.
Computing the cosine similarity matrix...
Done computing similarity matrix.
Computing the cosine similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.8285  0.8282  0.8278  0.8282  0.0003  
RMSE (testset)    1.0435  1.0395  1.0430  1.0420  0.0018  
Fit time          1.67    1.65    1.58    1.63    0.04    
Test time         6.60    6.87    6.93    6.80    0.14    
Test RMSE=1.0401501772737274
Computing the pearson similarity matrix...
Done computing similarity matrix.
Computing the pearson similarity matrix...
Done computing similarity matrix.
Computing the pearson similarity matrix...
Done computing similarity matrix.
Evaluating RMSE, MAE of algorithm KNNBasic on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.8447  0.8396  0.8426  0.8423  0.0021  
RMSE (testset)    1.0542  1.0525  1.0548  1.0539  0.0010  
Fit time          2.51    2.35    2.57    2.48    0.09    
Test time         6.48    6.90    6.39    6.59    0.22    
Test RMSE=1.051538692275093
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>predict() 함수를 통해 한 데이터 셋에 대해서 예측 평점을 구할 수 있으며, Top-N 개의 비슷한 아이템이나, 사용자를 찾을 수 있습니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># 평가: by predict</span>
<span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sp_test</span><span class="p">:</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">est</span><span class="p">)</span>

<span class="n">rmse</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test RMSE=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Test RMSE=1.051538692275093
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top-N Similar Users&quot;</span><span class="p">)</span>
<span class="n">user_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># sp.KNNBasic(sim_options={&#39;name&#39; : &#39;msd&#39;})</span>
<span class="n">raw_uid</span> <span class="o">=</span> <span class="s1">&#39;22&#39;</span>
<span class="n">inner_uid</span> <span class="o">=</span> <span class="n">user_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_inner_uid</span><span class="p">(</span><span class="n">raw_uid</span><span class="p">)</span>
<span class="n">raw_uid</span> <span class="o">=</span> <span class="n">user_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_raw_uid</span><span class="p">(</span><span class="n">inner_uid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;raw_uid:</span><span class="si">{}</span><span class="s2"> == inner_uid:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_uid</span><span class="p">,</span> <span class="n">inner_uid</span><span class="p">))</span>

<span class="n">top_inner_uids</span> <span class="o">=</span> <span class="n">user_model</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">inner_uid</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;top-5 inner_uids: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_inner_uids</span><span class="p">))</span>
<span class="n">top_raw_uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_raw_uid</span><span class="p">(</span><span class="n">top_inner_uid</span><span class="p">)</span> <span class="k">for</span> <span class="n">top_inner_uid</span> <span class="ow">in</span> <span class="n">top_inner_uids</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;top-5 raw_uids: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_raw_uids</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top-N Similar Items&quot;</span><span class="p">)</span>
<span class="n">item_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># sp.KNNBasic(sim_options={&#39;name&#39; : &#39;msd&#39;, &#39;user_based&#39;: False})</span>
<span class="n">raw_iid</span> <span class="o">=</span> <span class="s1">&#39;377&#39;</span>
<span class="n">inner_iid</span> <span class="o">=</span> <span class="n">item_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_inner_iid</span><span class="p">(</span><span class="n">raw_iid</span><span class="p">)</span>
<span class="n">raw_iid</span> <span class="o">=</span> <span class="n">item_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_raw_iid</span><span class="p">(</span><span class="n">inner_iid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;raw_iid:</span><span class="si">{}</span><span class="s2"> == inner_iid:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_iid</span><span class="p">,</span> <span class="n">inner_iid</span><span class="p">))</span>

<span class="n">top_inner_iids</span> <span class="o">=</span> <span class="n">item_model</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">inner_iid</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;top-5 inner_iids: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_inner_iids</span><span class="p">))</span>
<span class="n">top_raw_iids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_model</span><span class="o">.</span><span class="n">trainset</span><span class="o">.</span><span class="n">to_raw_iid</span><span class="p">(</span><span class="n">top_inner_iid</span><span class="p">)</span> <span class="k">for</span> <span class="n">top_inner_iid</span> <span class="ow">in</span> <span class="n">top_inner_iids</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;top-5 raw_iids: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_raw_iids</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Top-N Similar Users
raw_uid:22 == inner_uid:493
top-5 inner_uids: [3, 32, 85, 100, 174]
top-5 raw_uids: [&#39;803&#39;, &#39;703&#39;, &#39;494&#39;, &#39;787&#39;, &#39;802&#39;]

Top-N Similar Items
raw_iid:377 == inner_iid:610
top-5 inner_iids: [1, 15, 30, 47, 56]
top-5 raw_iids: [&#39;597&#39;, &#39;402&#39;, &#39;356&#39;, &#39;365&#39;, &#39;406&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-based-CF">Model-based CF<a class="anchor-link" href="#Model-based-CF">&#182;</a></h2><p>평점 데이터를 통해 모델을 만드는 방법은 다양한 접근이 가능하지만, 그 중 행렬의 연산을 이용하여 특징벡터를 추출하여 사용하는 Matrix Factorization을 많이 사용합니다. Matrix Factorization 문제에 대한 해를 찾는 방법은 여러가지가 있지만 그 중에서도 일반적으로 SVD(Singular Value Decomposition)방법을 사용합니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">preprocessing</span><span class="p">,</span> <span class="n">model_selection</span><span class="p">,</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">surprise</span> <span class="k">as</span> <span class="nn">sp</span>

<span class="c1"># 데이터</span>
<span class="n">sp_data</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-100k&#39;</span><span class="p">)</span>
<span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sp_data</span><span class="o">.</span><span class="n">raw_ratings</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_data.shape=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>

<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># 전처리 </span>
<span class="c1"># A reader is still needed but only the rating_scale param is requiered.</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">rating_scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sp_data</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">reader</span><span class="p">)</span>
<span class="c1"># surprise model.test 의 input shape =&gt; [(user_id, item_id, rating)]</span>
<span class="n">sp_test</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_test</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

<span class="c1"># 모델</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">SVD</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>    
<span class="p">]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="c1"># 학습</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sp_data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># 평가</span>
    <span class="n">sp_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">sp_test</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">accuracy</span><span class="o">.</span><span class="n">rmse</span><span class="p">(</span><span class="n">sp_pred</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test RMSE=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>df_data.shape=(100000, 4)
user_id       object
item_id       object
rating       float64
timestamp     object
dtype: object
  user_id item_id  rating  timestamp
0     196     242     3.0  881250949
1     186     302     3.0  891717742
2      22     377     1.0  878887116
3     244      51     2.0  880606923
4     166     346     1.0  886397596
       user_id item_id         rating  timestamp
count   100000  100000  100000.000000     100000
unique     943    1682            NaN      49282
top        405      50            NaN  891033606
freq       737     583            NaN         12
mean       NaN     NaN       3.529860        NaN
std        NaN     NaN       1.125674        NaN
min        NaN     NaN       1.000000        NaN
25%        NaN     NaN       3.000000        NaN
50%        NaN     NaN       4.000000        NaN
75%        NaN     NaN       4.000000        NaN
max        NaN     NaN       5.000000        NaN
(100000, 4) (90000, 4) (10000, 4)
Evaluating RMSE, MAE of algorithm SVD on 3 split(s).

                  Fold 1  Fold 2  Fold 3  Mean    Std     
MAE (testset)     0.7494  0.7447  0.7462  0.7468  0.0020  
RMSE (testset)    0.9492  0.9441  0.9432  0.9455  0.0027  
Fit time          2.08    2.01    2.15    2.08    0.06    
Test time         0.39    0.40    0.41    0.40    0.01    
Test RMSE=0.9465768404143768
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>predict() 함수를 통해 한 데이터 셋에 대해서 예측 평점을 구할 수 있습니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># 평가: by predict</span>
<span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sp_test</span><span class="p">:</span>
    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">est</span><span class="p">)</span>

<span class="n">rmse</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test RMSE=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Test RMSE=0.9465768404143768
</pre>
</div>
</div>

</div>
</div>

</div>
 

